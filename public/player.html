<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lie-Ability - Player</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
      padding: 0;
    }

    /* Header */
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 4px;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #68d391;
      font-weight: 500;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #68d391;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Main Content */
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 60px 20px 20px 20px;
      min-height: 100vh;
    }

    /* Join Section */
    .join-section {
      background: white;
      border-radius: 20px;
      padding: 32px 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      text-align: center;
      margin-top: 20px;
    }

    .join-title {
      font-size: 32px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 8px;
    }

    .join-title::before {
      content: "üé≠ ";
      font-size: 40px;
      display: block;
      margin-bottom: 16px;
    }

    .join-subtitle {
      color: #718096;
      margin-bottom: 32px;
      font-size: 16px;
    }

    .input-group {
      margin-bottom: 24px;
    }

    .input-field {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      background: #f7fafc;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-primary {
      width: 100%;
      padding: 16px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    /* Game Views */
    .view {
      display: none;
      animation: slideInUp 0.4s ease-out;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card-header {
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 8px;
    }

    .card-subtitle {
      color: #718096;
      font-size: 14px;
    }

    /* Avatar Section */
    .avatar-section {
      text-align: center;
    }

    .avatar-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .player-avatar {
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      color: #fff;
      font-size: 32px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary {
      padding: 12px 20px;
      background: #f7fafc;
      color: #4a5568;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: #edf2f7;
      border-color: #cbd5e0;
    }

    .avatar-edit {
      margin-top: 20px;
      padding: 20px;
      background: #f7fafc;
      border-radius: 16px;
      border: 2px dashed #cbd5e0;
    }

    .avatar-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }

    .avatar-update-section {
      width: 100%;
      text-align: center;
    }

    .name-update-section {
      width: 100%;
      text-align: center;
      margin-top: 20px;
    }

    .emoji-input-container {
      position: relative;
      display: inline-block;
    }

    .color-input {
      width: 50px;
      height: 40px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .emoji-button {
      padding: 8px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      font-size: 24px;
      min-width: 60px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .emoji-button:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
      transform: scale(1.05);
    }

    .custom-emoji-picker {
      background: white;
      border: none;
      border-radius: 16px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
      width: 350px;
      position: absolute;
      z-index: 1000;
      margin-top: 8px;
      left: 0;
      max-width: calc(100vw - 40px);
      overflow: hidden;
    }

    .picker-header {
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 16px 16px 0 0;
    }

    .picker-header h4 {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 600;
    }

    .emoji-search {
      width: 100%;
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      box-sizing: border-box;
    }

    .emoji-search::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .emoji-search:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.3);
    }

    .emoji-categories {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }

    .emoji-category-tab {
      flex: 1;
      padding: 12px 4px;
      text-align: center;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      background: transparent;
    }

    .emoji-category-tab:hover {
      background: #e9ecef;
    }

    .emoji-category-tab.active {
      background: white;
      border-bottom-color: #667eea;
    }

    .emoji-grid-container {
      height: 220px;
      overflow-y: auto;
      padding: 12px;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      gap: 8px;
    }

    .emoji-option {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .emoji-option:hover {
      background: #f8f9fa;
      transform: scale(1.1);
    }

    .emoji-option:active {
      transform: scale(0.95);
    }

    /* Buttons Grid */
    .btn-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr;
    }

    .btn-option {
      padding: 16px 20px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .btn-option:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
    }

    .btn-option.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }

    /* Question Display */
    .question-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 32px 24px;
      text-align: center;
    }

    #questionView {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .question-category {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .question-text {
      font-size: 20px;
      font-weight: 600;
      line-height: 1.4;
    }

    /* Input Controls */
    .input-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .input-controls .input-field {
      flex: 1;
    }

    .btn-small {
      padding: 12px 16px;
      font-size: 14px;
      border-radius: 8px;
      white-space: nowrap;
    }

    /* Status Messages */
    .status-message {
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      margin-top: 12px;
    }

    .status-success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .status-info {
      background: #bee3f8;
      color: #2a4365;
      border: 1px solid #90cdf4;
    }

    /* Timer */
    .timer {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      color: #e53e3e;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      z-index: 50;
    }

    /* Connection Status */
    .connection-status {
      position: fixed;
      top: 20px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #68d391;
      font-weight: 500;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 8px 16px;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      z-index: 50;
    }

    /* Reveal and Scoreboard */
    .reveal-list {
      list-style: none;
      padding: 0;
    }

    .reveal-item {
      background: #f7fafc;
      margin-bottom: 12px;
      padding: 16px;
      border-radius: 12px;
      border-left: 4px solid #cbd5e0;
    }

    .reveal-item.truth {
      background: #c6f6d5;
      border-left-color: #38a169;
    }

    .score-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .score-table th,
    .score-table td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    .score-table th {
      background: #f7fafc;
      font-weight: 600;
      color: #4a5568;
    }

    .score-table tr:hover {
      background: #f7fafc;
    }

    /* Loading States */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #718096;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #e2e8f0;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
      .container {
        padding: 60px 16px 16px 16px;
      }

      .header {
        padding: 12px 16px;
      }

      .header h1 {
        font-size: 20px;
      }

      .card {
        padding: 20px;
        margin-bottom: 16px;
      }

      .custom-emoji-picker {
        width: calc(100vw - 32px);
        left: 16px;
        right: 16px;
        transform: none;
        max-width: none;
      }

      .emoji-grid {
        grid-template-columns: repeat(8, 1fr);
        gap: 6px;
      }

      .emoji-option {
        width: 32px;
        height: 32px;
        font-size: 20px;
      }

      .emoji-category-tab {
        padding: 8px 2px;
        font-size: 16px;
      }

      .picker-header {
        padding: 12px;
      }

      .emoji-grid-container {
        height: 180px;
        padding: 8px;
      }

      .player-avatar {
        width: 50px;
        height: 50px;
        font-size: 24px;
      }

      .avatar-controls {
        justify-content: center;
      }

      .input-controls {
        flex-direction: column;
      }

      .connection-status {
        top: 16px;
        left: 16px;
        padding: 6px 12px;
        font-size: 12px;
      }

      .timer {
        top: 16px;
        right: 16px;
        padding: 6px 12px;
        font-size: 14px;
      }
    }

    /* Desktop Enhancements */
    @media (min-width: 768px) {
      .container {
        max-width: 600px;
        padding: 60px 32px 32px 32px;
      }

      .avatar-controls {
        justify-content: center;
      }
    }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* High contrast mode */
    @media (prefers-contrast: high) {
      .btn-primary {
        background: #000;
        border: 2px solid #000;
      }

      .card {
        border: 2px solid #333;
      }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
      }

      .header {
        background: rgba(26, 32, 44, 0.95);
        border-bottom-color: rgba(255, 255, 255, 0.1);
      }

      .header h1 {
        color: #f7fafc;
      }

      .card {
        background: #2d3748;
        color: #f7fafc;
        border-color: rgba(255, 255, 255, 0.1);
      }

      .card-title {
        color: #f7fafc;
      }

      .input-field {
        background: #4a5568;
        border-color: #718096;
        color: #f7fafc;
      }

      .btn-secondary {
        background: #4a5568;
        color: #f7fafc;
        border-color: #718096;
      }
    }

    .no-results {
      text-align: center;
      color: #718096;
      font-style: italic;
      padding: 32px 16px;
      font-size: 14px;
    }
  </style>
</head>
<body>


  <div class="connection-status">
    <div class="status-dot"></div>
    <span id="connection">Connecting...</span>
  </div>

  <div class="container">
    <div id="joinSection" class="join-section">
      <div class="join-title">Join the Game</div>
      <div class="join-subtitle">Enter your name to start playing</div>
      <div class="input-group">
        <input id="nameInput" class="input-field" placeholder="Your name" type="text">
      </div>
      <button id="joinBtn" class="btn-primary">Join Game</button>
    </div>

    <div id="views" style="display:none;">
      <!-- Lobby View -->
      <div id="lobbyView" class="view">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Game Lobby</div>
            <div class="card-subtitle">Waiting for the host to start the game...</div>
          </div>
          
          <div class="avatar-section">
            <div class="card-title" style="margin-bottom: 16px;">Customize Your Avatar</div>
            <div class="avatar-display">
              <span id="avatarPreview" class="player-avatar">üòä</span>
              <button id="editAvatarBtn" class="btn-secondary">Edit Avatar</button>
            </div>
            
            <div id="avatarEdit" class="avatar-edit" style="display:none;">
              <div class="avatar-controls">
                <div class="emoji-input-container">
                  <button id="emojiButton" class="emoji-button">üòä</button>
                  <div id="customEmojiPicker" class="custom-emoji-picker" style="display:none;">
                    <div class="picker-header">
                      <h4>Choose an Emoji</h4>
                      <input id="emojiSearch" class="emoji-search" placeholder="Search emojis...">
                    </div>
                    <div class="emoji-categories">
                      <div class="emoji-category-tab active" data-category="smileys">üòÄ</div>
                      <div class="emoji-category-tab" data-category="animals">üê±</div>
                      <div class="emoji-category-tab" data-category="food">üçï</div>
                      <div class="emoji-category-tab" data-category="activities">‚öΩ</div>
                      <div class="emoji-category-tab" data-category="travel">‚úàÔ∏è</div>
                      <div class="emoji-category-tab" data-category="objects">üí°</div>
                      <div class="emoji-category-tab" data-category="symbols">üíñ</div>
                    </div>
                    <div class="emoji-grid-container">
                      <div id="emojiGrid" class="emoji-grid"></div>
                    </div>
                  </div>
                </div>
                <input id="colorInput" class="color-input" type="color" value="#667eea">
              </div>
              <div class="avatar-update-section">
                <button id="avatarBtn" class="btn-primary">Update Avatar</button>
              </div>
            </div>
          </div>
          <div class="name-update-section">
            <div class="input-group">
              <input id="nameEditInput" class="input-field" placeholder="Your name" type="text">
            </div>
            <button id="nameBtn" class="btn-primary btn-small">Update Name</button>
          </div>
        </div>
      </div>

      <!-- Category Selection View -->
      <div id="categoryView" class="view">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Choose a Category</div>
            <div class="card-subtitle" id="categoryPrompt">Select a category for the next question</div>
          </div>
          <div id="categoryButtons" class="btn-grid"></div>
        </div>
      </div>

      <!-- Question Reading View -->
      <div id="questionView" class="view">
        <div class="card question-card">
          <div class="question-category" id="questionCategory">Category</div>
          <div class="question-text" id="questionText">Question will appear here...</div>
        </div>
        <div class="card">
          <div class="loading">
            <div class="spinner"></div>
            <span>Read the question carefully...</span>
          </div>
        </div>
      </div>

      <!-- Lie Submission View -->
      <div id="lieView" class="view">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Submit Your Lie</div>
            <div class="card-subtitle">Create a believable false answer</div>
          </div>
          <div class="input-group">
            <input id="lieInput" class="input-field" placeholder="Enter your lie...">
          </div>
          <button id="submitLie" class="btn-primary">Submit Lie</button>
          <button id="autoLie" class="btn-secondary" style="margin-top: 12px; width: 100%;">Lie for Me</button>
          <div id="lieStatus"></div>
        </div>
      </div>

      <!-- Voting View -->
      <div id="voteView" class="view">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Vote for the Truth</div>
            <div class="card-subtitle">Which answer do you think is correct?</div>
          </div>
          <div id="options" class="btn-grid"></div>
          <button id="likeBtn" class="btn-secondary" style="display:none; margin-top: 12px;">üëç Like This Answer</button>
          <div id="voteStatus"></div>
        </div>
      </div>

      <!-- Reveal View -->
      <div id="revealView" class="view">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Results</div>
            <div class="card-subtitle" id="revealQuestion">Question results</div>
          </div>
          <ul id="revealList" class="reveal-list"></ul>
        </div>
      </div>

      <!-- Scoreboard View -->
      <div id="scoreboardView" class="view">
        <div class="card">
          <div class="card-header">
            <div class="card-title">üèÜ Scoreboard</div>
            <div class="card-subtitle">Current standings</div>
          </div>
          <table id="scoreTable" class="score-table"></table>
        </div>
      </div>
    </div>

    <div id="timer" class="timer" style="display:none;"></div>
  </div>

  <pre id="log" style="display:none;"></pre>

<script>
const socket = io();
let playerId = null;
// Attempt automatic reconnection using stored info
const storedId = localStorage.getItem('playerId');
const storedName = localStorage.getItem('playerName');
if(storedId && storedName){
  playerId = storedId;
  document.getElementById('joinSection').style.display = 'none';
  document.getElementById('views').style.display = 'block';
  document.getElementById('lobbyView').style.display = 'block';
  socket.emit('join_game', { playerName: storedName, playerId: storedId });
  document.getElementById('nameEditInput').value = storedName;
} else if(storedName){
  document.getElementById('nameInput').value = storedName;
  document.getElementById('nameEditInput').value = storedName;
}
let gameState = null;
let subStep = null;
let selectedOption = null;
let editingAvatar = false;
let selectedEmoji = 'üòä';
let currentEmojiCategory = 'smileys';

const views = {
  lobby: document.getElementById('lobbyView'),
  category: document.getElementById('categoryView'),
  question: document.getElementById('questionView'),
  lie: document.getElementById('lieView'),
  vote: document.getElementById('voteView'),
  reveal: document.getElementById('revealView'),
  score: document.getElementById('scoreboardView')
};

// Emoji data for the custom picker
const emojiData = {
  smileys: [
    'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ',
    'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô',
    'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î',
    'üòê', 'ü§ê', 'ü§®', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•',
    'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß',
    'ü•µ', 'ü•∂', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê'
  ],
  animals: [
    'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ',
    'ü¶Å', 'üêÆ', 'üê∑', 'üêΩ', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí',
    'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'üê•', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á',
    'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú',
    'ü¶ü', 'ü¶ó', 'üï∑Ô∏è', 'üï∏Ô∏è', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï',
    'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥'
  ],
  food: [
    'üçè', 'üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê',
    'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë',
    'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü´ë', 'üåΩ', 'ü•ï', 'ü´í', 'üßÑ', 'üßÖ',
    'ü•î', 'üç†', 'ü•ê', 'ü•Ø', 'üçû', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ö', 'üç≥',
    'üßà', 'ü•û', 'üßá', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'ü¶¥', 'üå≠', 'üçî',
    'üçü', 'üçï', 'ü•™', 'ü•ô', 'üåÆ', 'üåØ', 'ü´î', 'ü•ó', 'ü•ò', 'ü´ï'
  ],
  activities: [
    '‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±',
    'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü™É', 'ü•Ö', '‚õ≥',
    'ü™Å', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üéΩ', 'üõπ', 'üõ∑', '‚õ∏Ô∏è',
    'ü•å', 'üéø', '‚õ∑Ô∏è', 'üèÇ', 'ü™Ç', 'üèãÔ∏è', 'ü§º', 'ü§∏', '‚õπÔ∏è', 'ü§∫',
    'üèá', 'üßò', 'üèÑ', 'üèä', 'ü§Ω', 'üö£', 'üßó', 'üöµ', 'üö¥', 'üèÜ',
    'ü•á', 'ü•à', 'ü•â', 'üèÖ', 'üéñÔ∏è', 'üèµÔ∏è', 'üéóÔ∏è', 'üé´', 'üéüÔ∏è', 'üé™'
  ],
  travel: [
    'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê',
    'üõª', 'üöö', 'üöõ', 'üöú', 'üèçÔ∏è', 'üõµ', 'üö≤', 'üõ¥', 'üõ∫', 'üöÅ',
    'üõ∏', '‚úàÔ∏è', 'üõ©Ô∏è', 'üõ´', 'üõ¨', 'ü™Ç', 'üí∫', 'üöÄ', 'üõ∞Ô∏è', 'üö¢',
    '‚õµ', 'üö§', 'üõ•Ô∏è', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üöÜ', 'üöÑ', 'üöÖ', 'üöà', 'üöù',
    'üöû', 'üöã', 'üöÉ', 'üöü', 'üö†', 'üö°', 'üé¢', 'üé°', 'üé†', 'üèóÔ∏è',
    'üåâ', 'üè∞', 'üèØ', 'üèüÔ∏è', 'üé™', 'üé≠', 'üóº', 'üóΩ', '‚õ™', 'üïå'
  ],
  objects: [
    '‚åö', 'üì±', 'üì≤', 'üíª', '‚å®Ô∏è', 'üñ•Ô∏è', 'üñ®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üïπÔ∏è',
    'üóúÔ∏è', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üìº', 'üì∑', 'üì∏', 'üìπ', 'üé•',
    'üìΩÔ∏è', 'üéûÔ∏è', 'üìû', '‚òéÔ∏è', 'üìü', 'üì†', 'üì∫', 'üìª', 'üéôÔ∏è', 'üéöÔ∏è',
    'üéõÔ∏è', 'üß≠', '‚è±Ô∏è', '‚è≤Ô∏è', '‚è∞', 'üï∞Ô∏è', '‚è≥', '‚åõ', 'üì°', 'üîã',
    'üîå', 'üí°', 'üî¶', 'üïØÔ∏è', 'ü™î', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥',
    'üí∂', 'üí∑', 'üí∞', 'üí≥', 'üíé', '‚öñÔ∏è', 'üß∞', 'üîß', 'üî®', '‚öíÔ∏è'
  ],
  symbols: [
    '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî',
    '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíã', 'üíå',
    'üí§', 'üí¢', 'üí£', 'üí•', 'üí¶', 'üí®', 'üí´', 'üí¨', 'üëÅÔ∏è‚Äçüó®Ô∏è', 'üó®Ô∏è',
    'üóØÔ∏è', 'üí≠', 'üíØ', 'üíÆ', '‚ô®Ô∏è', 'üíà', 'üõë', 'üïõ', 'üïß', 'üïê',
    'üïú', 'üïë', 'üïù', 'üïí', 'üïû', 'üïì', 'üïü', 'üïî', 'üï†', 'üïï',
    'üï°', 'üïñ', 'üï¢', 'üïó', 'üï£', 'üïò', 'üï§', 'üïô', 'üï•', 'üïö'
  ]
};

function hideAll(){ Object.values(views).forEach(v=>v.style.display='none'); }
function show(name){ hideAll(); if(views[name]) views[name].style.display='block'; }
function log(msg){ document.getElementById('log').textContent+=msg+'\n'; }

function updateAvatarUI(avatar){
  if(!avatar) return;
  document.getElementById('avatarPreview').textContent = avatar.emoji;
  document.getElementById('avatarPreview').style.backgroundColor = avatar.color;
  document.getElementById('emojiButton').textContent = avatar.emoji;
  document.getElementById('colorInput').value = avatar.color;
  selectedEmoji = avatar.emoji;
}

// Custom emoji picker functions
function renderEmojiGrid(emojis) {
  const grid = document.getElementById('emojiGrid');
  
  if (emojis.length === 0) {
    grid.innerHTML = '<div class="no-results">No emojis found üîç</div>';
    return;
  }
  
  grid.innerHTML = emojis.map(emoji => 
    `<div class="emoji-option" onclick="selectEmoji('${emoji}')">${emoji}</div>`
  ).join('');
}

function selectEmoji(emoji) {
  selectedEmoji = emoji;
  document.getElementById('emojiButton').textContent = emoji;
  updateAvatarUI({
    emoji: emoji,
    color: document.getElementById('colorInput').value || '#667eea'
  });
  // Close the picker
  document.getElementById('customEmojiPicker').style.display = 'none';
}

function switchEmojiCategory(category) {
  currentEmojiCategory = category;
  
  // Update active tab
  document.querySelectorAll('.emoji-category-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelector(`[data-category="${category}"]`).classList.add('active');
  
  // Clear search
  document.getElementById('emojiSearch').value = '';
  
  // Render emojis for the category
  renderEmojiGrid(emojiData[category]);
}

function searchEmojis() {
  const searchTerm = document.getElementById('emojiSearch').value.toLowerCase();
  
  if (searchTerm === '') {
    renderEmojiGrid(emojiData[currentEmojiCategory]);
    return;
  }
  
  // Search through all emojis
  const allEmojis = Object.values(emojiData).flat();
  // For a simple implementation, just show first 50 results
  renderEmojiGrid(allEmojis.slice(0, 50));
}

// Initialize emoji picker
document.addEventListener('DOMContentLoaded', () => {
  renderEmojiGrid(emojiData.smileys);
  
  // Category tabs
  document.querySelectorAll('.emoji-category-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      switchEmojiCategory(tab.dataset.category);
    });
  });
  
  // Search input
  document.getElementById('emojiSearch').addEventListener('input', searchEmojis);
  
  // Emoji button click
  document.getElementById('emojiButton').addEventListener('click', (e) => {
    e.stopPropagation();
    const picker = document.getElementById('customEmojiPicker');
    const isVisible = picker.style.display !== 'none';
    picker.style.display = isVisible ? 'none' : 'block';
    
    if (!isVisible) {
      // Position the picker to avoid getting cut off
      const button = document.getElementById('emojiButton');
      const buttonRect = button.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      
      // On mobile, use fixed positioning with margins
      if (viewportWidth <= 480) {
        picker.style.position = 'fixed';
        picker.style.left = '16px';
        picker.style.right = '16px';
        picker.style.top = 'auto';
        picker.style.bottom = '20px';
        picker.style.transform = 'none';
        picker.style.zIndex = '9999';
      } else {
        // Desktop positioning logic
        picker.style.transform = 'none';
        picker.style.right = 'auto';
        if (buttonRect.left + 350 > viewportWidth) {
          picker.style.left = 'auto';
          picker.style.right = '0';
        } else {
          picker.style.left = '0';
          picker.style.right = 'auto';
        }
      }
    }
  });
  
  // Close picker when clicking outside
  document.addEventListener('click', (e) => {
    const picker = document.getElementById('customEmojiPicker');
    const button = document.getElementById('emojiButton');
    if (!picker.contains(e.target) && e.target !== button) {
      picker.style.display = 'none';
      // Reset positioning
      picker.style.position = 'absolute';
      picker.style.top = 'auto';
      picker.style.bottom = 'auto';
      picker.style.transform = 'none';
    }
  });

  // Enter key support for name input
  document.getElementById('nameInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('joinBtn').click();
    }
  });

  // Enter key support for lie input
  document.getElementById('lieInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('submitLie').click();
    }
  });
});

socket.on('connect', () => { 
  document.getElementById('connection').textContent = 'Connected';
  document.getElementById('connection').parentElement.style.color = '#68d391';
});

socket.on('disconnect', () => { 
  document.getElementById('connection').textContent = 'Disconnected';
  document.getElementById('connection').parentElement.style.color = '#e53e3e';
});

socket.on('player_joined', data => {
  if(!playerId && data.player){
    playerId = data.player.id;
    localStorage.setItem('playerId', playerId);
    localStorage.setItem('playerName', data.player.name);
    document.getElementById('joinSection').style.display='none';
    document.getElementById('views').style.display='block';
    updateAvatarUI(data.player.avatar);
    document.getElementById('nameEditInput').value = data.player.name;
  }
  if(data.gameState){
    gameState = data.gameState;
    render();
  }
});

socket.on('player_reconnected', d => {
  if(d.success){
    playerId = d.playerId;
    localStorage.setItem('playerId', playerId);
    if(d.playerName) localStorage.setItem('playerName', d.playerName);
    document.getElementById('joinSection').style.display='none';
    document.getElementById('views').style.display='block';
    if(d.playerName) document.getElementById('nameEditInput').value = d.playerName;
    if(d.gameState){ gameState = d.gameState; render(); }
  } else if(d.playerId === playerId){
    socket.emit('request_game_state');
  }
});

socket.on('game_state_update', d => {
  gameState=d;
  if(playerId){
    const me = (d.players||[]).find(p=>p.id===playerId);
    if(me){
      updateAvatarUI(me.avatar);
      document.getElementById('nameEditInput').value = me.name;
    }
  }
  render();
});

socket.on('sub_step_info', d => { subStep=d; render(); });

socket.on('timer_update', d => { 
  const timer = document.getElementById('timer');
  timer.textContent = `‚è±Ô∏è ${d.secondsRemaining}s`;
  timer.style.display = 'block';
  
  // Change color based on time remaining
  if (d.secondsRemaining <= 10) {
    timer.style.background = 'rgba(229, 62, 62, 0.95)';
    timer.style.color = 'white';
  } else if (d.secondsRemaining <= 30) {
    timer.style.background = 'rgba(237, 137, 54, 0.95)';
    timer.style.color = 'white';
  } else {
    timer.style.background = 'rgba(255, 255, 255, 0.95)';
    timer.style.color = '#e53e3e';
  }
});

socket.on('lie_submitted', () => { 
  const status = document.getElementById('lieStatus');
  status.innerHTML = '<div class="status-message status-success">‚úÖ Lie submitted successfully!</div>';
});

socket.on('option_selected', () => { 
  const status = document.getElementById('voteStatus');
  status.innerHTML = '<div class="status-message status-success">‚úÖ Vote submitted!</div>';
});

socket.on('truth_reveal_start', d => renderReveal(d));
socket.on('scoreboard_update', d => renderScoreboard(d));

socket.on('lie_liked', () => { 
  const btn = document.getElementById('likeBtn');
  btn.style.display = 'none';
  btn.innerHTML = 'üëç Liked!';
});

socket.on('player_avatar_updated', d => {
  if(d.playerId === playerId) updateAvatarUI(d.avatar);
  socket.emit('request_game_state');
  editingAvatar = false;
  document.getElementById('avatarEdit').style.display = 'none';
  document.getElementById('customEmojiPicker').style.display = 'none';
});

socket.on('error', data => log('Error: '+data.message));

document.getElementById('joinBtn').onclick = () => {
  const name=document.getElementById('nameInput').value.trim();
  if(name){ socket.emit('join_game',{playerName:name}); }
};

document.getElementById('submitLie').onclick = () => {
  const lie=document.getElementById('lieInput').value.trim();
  if(lie){ 
    socket.emit('submit_lie',{lie}); 
    document.getElementById('lieInput').value = '';
  }
};

document.getElementById('autoLie').onclick = () => { socket.emit('auto_lie'); };

document.getElementById('likeBtn').onclick = () => {
  if(selectedOption && selectedOption.submittedById && selectedOption.submittedById !== playerId){
    socket.emit('like_lie', { likedPlayerId: selectedOption.submittedById });
    document.getElementById('likeBtn').disabled = true;
  }
};

// Update preview when color changes
document.getElementById('colorInput').addEventListener('input', e => {
  updateAvatarUI({
    emoji: selectedEmoji,
    color: e.target.value
  });
});

document.getElementById('editAvatarBtn').onclick = () => {
  editingAvatar = !editingAvatar;
  document.getElementById('avatarEdit').style.display = editingAvatar ? 'block' : 'none';
  if (!editingAvatar) {
    document.getElementById('customEmojiPicker').style.display = 'none';
  }
};

document.getElementById('avatarBtn').onclick = () => {
  const emoji = selectedEmoji || 'üòÄ';
  const color = document.getElementById('colorInput').value || '#667eea';
  // Optimistically update the preview so players immediately see their choice
  updateAvatarUI({ emoji, color });
  socket.emit('update_avatar',{emoji,color});
  editingAvatar = false;
  document.getElementById('avatarEdit').style.display = 'none';
  document.getElementById('customEmojiPicker').style.display = 'none';
};

document.getElementById('nameBtn').onclick = () => {
  const newName = document.getElementById('nameEditInput').value.trim()
  if(newName){
    socket.emit('update_name', { name: newName })
    localStorage.setItem('playerName', newName)
  }
};

function render(){
  if(!gameState) return;
  
  const editingAllowed = gameState.state === 'lobby';
  document.getElementById('editAvatarBtn').disabled = !editingAllowed;
  document.getElementById('avatarBtn').disabled = !editingAllowed;
  document.getElementById('nameBtn').disabled = !editingAllowed;
  document.getElementById('nameEditInput').disabled = !editingAllowed;
  
  if(!editingAllowed){
    editingAvatar = false;
    document.getElementById('avatarEdit').style.display = 'none';
    document.getElementById('customEmojiPicker').style.display = 'none';
  }
  
  // Hide timer by default
  document.getElementById('timer').style.display = 'none';
  
  // Clear status messages when switching views
  document.getElementById('lieStatus').innerHTML = '';
  document.getElementById('voteStatus').innerHTML = '';
  
  switch(gameState.state){
    case 'lobby':
      show('lobby');
      break;
    case 'category_selection':
      show('category');
      renderCategory();
      break;
    case 'question_reading':
      show('question');
      renderQuestion();
      break;
    case 'lie_submission':
      show('lie');
      // Clear the lie input when entering this view
      document.getElementById('lieInput').value = '';
      break;
    case 'option_selection':
      show('vote');
      renderOptions();
      break;
    case 'truth_reveal':
      break;
    case 'scoreboard':
    case 'game_ended':
      break;
  }
}

function renderCategory(){
  const container=document.getElementById('categoryButtons');
  container.innerHTML='';
  
  if(subStep?.categories){
    subStep.categories.forEach(c => {
      const btn=document.createElement('button');
      btn.className = 'btn-option';
      btn.textContent=c.category;
      if(subStep.isSelector){
        btn.onclick=()=>{
          // Visual feedback
          document.querySelectorAll('.btn-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          socket.emit('select_category',{categoryId:c.id}); 
        };
      } else {
        btn.disabled = true;
        btn.style.opacity = '0.6';
      }
      container.appendChild(btn);
    });
  }
  
  const selectorName=gameState.players.find(p=>p.id===gameState.categorySelector)?.name || '';
  document.getElementById('categoryPrompt').textContent=subStep.isSelector ? 
    'Choose a category for the next question' : 
    `Waiting for ${selectorName} to choose...`;
}

function renderQuestion(){
  const q=subStep?.question || gameState.currentQuestionData;
  if(q) {
    document.getElementById('questionCategory').textContent = q.category;
    document.getElementById('questionText').textContent = q.question;
  }
}

function renderOptions(){
  const container=document.getElementById('options');
  container.innerHTML='';
  
  if(subStep?.options){
    subStep.options.forEach(opt => {
      const btn=document.createElement('button');
      btn.className = 'btn-option';
      btn.textContent=opt.text;
      btn.onclick=()=>{
        // Clear previous selections
        document.querySelectorAll('.btn-option').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        
        selectedOption=opt;
        socket.emit('select_option',{optionId:opt.id});
        
        // Toggle like button only for lies from other players
        const likeBtnElem = document.getElementById('likeBtn');
        if(opt.submittedById && opt.submittedById !== playerId) {
          likeBtnElem.style.display = 'block';
          likeBtnElem.disabled = false;
        } else {
          likeBtnElem.style.display = 'none';
        }
      };
      container.appendChild(btn);
    });
  }
}

function renderReveal(data){
  show('reveal');
  document.getElementById('revealQuestion').textContent = data.question;
  const list=document.getElementById('revealList');
  list.innerHTML='';
  
  data.lies.forEach(l=>{
    const li=document.createElement('li');
    li.className = 'reveal-item';
    li.innerHTML = `
      <strong>${l.lie}</strong><br>
      <small>${l.voteCount} vote${l.voteCount !== 1 ? 's' : ''}</small>
    `;

    if(l.submittedById !== playerId){
      const likeBtn=document.createElement('button');
      likeBtn.className='btn-secondary';
      likeBtn.style.marginLeft='8px';
      likeBtn.textContent='üëç Like';
      likeBtn.onclick=()=>{
        socket.emit('like_lie',{likedPlayerId:l.submittedById});
        likeBtn.disabled=true;
      };
      li.appendChild(likeBtn);
    }

    list.appendChild(li);
  });
  
  const truth=document.createElement('li');
  truth.className = 'reveal-item truth';
  truth.innerHTML = `
    <strong>‚úÖ Truth: ${data.truth.answer}</strong><br>
    <small>${data.truth.voteCount} correct guess${data.truth.voteCount !== 1 ? 'es' : ''}</small>
  `;
  list.appendChild(truth);
}

function renderScoreboard(data){
  show('score');
  const table=document.getElementById('scoreTable');
  table.innerHTML=`
    <thead>
      <tr>
        <th>Rank</th>
        <th>Player</th>
        <th>Last Lie</th>
        <th>Players Fooled</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  
  const tbody = table.querySelector('tbody');
  data.players.forEach(p=>{
    const row=document.createElement('tr');
    
    // Add medal emoji for top 3
    let rankDisplay = p.rank;
    if(p.rank === 1) rankDisplay = 'ü•á';
    else if(p.rank === 2) rankDisplay = 'ü•à';
    else if(p.rank === 3) rankDisplay = 'ü•â';
    
    row.innerHTML=`
      <td>${rankDisplay}</td>
      <td><strong>${p.name}</strong></td>
      <td>${p.lastLie || ''}</td>
      <td>${p.playersFooled}</td>
      <td>${p.points}</td>
    `;
    tbody.appendChild(row);
  });
}
</script>
</body>
</html>